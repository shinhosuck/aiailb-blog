{% extends 'blogs/index.html' %}
{% load static %}


<title>{% block title %} Home {% endblock title %}</title>



{% block content %}
        <!-- BLOG FORM SECTION-->
        <h2 class="new-post-header">Create post</h2>
        <div class="blog-form-container">
            <div class="user-img">
                {% if request.user.username %}
                    <a id="{{ request.user.username }}" class=form-user-info href="">
                        <img src="{% static 'blogs/profile_img/dog.webp' %}" alt="">
                        <span>{{ request.user.username }}</span>
                    </a>
                {% else %}
                    <div id="{{ request.user }}" class=form-user-info>
                        <img src="{% static 'blogs/profile_img/default.webp' %}" alt="">
                        <span>Annoymous</span>
                    </div>
                {% endif %}
            </div>
            <div class="blog-form">
                <form id="blog-form" action="{% url 'blogs:new-blog' %}" method="POST">
                    {% csrf_token %}
                    <input type="hidden" value="{% url 'blogs:home' %}" name="next">
                    <input type="text" name="title" placeholder="Title">
                    <textarea name="content" id="" cols="30" rows="10" placeholder="What is on your mind?"></textarea>
                    <button type="submit">Submit</button>
                </form>
            </div>
        </div>
        <!-- END OF BLOG FORM SECTION-->

    <!-- CONTENT SECTION -->
    <div class="contents-container">
        <h2 class="content-header">Latest blogs</h2>
        <div class="blogs-container">
        </div>
    </div>
    <!-- END OF CONTENT SECTION -->



    <!-- JAVASCRIPT -->
    <script type="text/javascript">
        // GLOBAL VAR
        const blogForm = document.querySelector("#blog-form")
        const blogsContainer = document.querySelector(".blogs-container")

        // handle blogs
        const handleBlogs = function(response){
            let blog = `
                        <div class="content">
                            {% if request.user.username %}
                                <a class="user-info">
                                    <img src="{% static 'blogs/profile_img/dog.webp' %}">
                                    <span>{{ request.user.username }}</span>
                                </a>
                            {% else %}
                                <div class="user-info">
                                    <img src="{% static 'blogs/profile_img/default.webp' %}">
                                    <span>{{ request.user }}</span>
                                </div>
                            {% endif %}
                            <h3 class="title">${response.title}</h3>
                            <p class="paragraph">${response.content}</p>
                        </div>
                    `
            blogsContainer.innerHTML = blog + blogsContainer.innerHTML
        }

        // handle new blog
        const eventHandler = function(event){
            if(event.target == blogForm) {
                event.preventDefault()

                const targetElement = event.target
                const newFormData = new FormData(targetElement)
                const url = targetElement.getAttribute("action")
                const method = targetElement.getAttribute("method")
                const xhr = new XMLHttpRequest()
                const responseType = 'json'

                xhr.responseType =responseType
                xhr.open(method, url)
                xhr.setRequestHeader('HTTP_X_REQUESTED_WITH', 'XMLHttpRequest')
                xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest')
                xhr.onload = function(){
                    blogForm.reset()
                    const response = xhr.response
                    handleBlogs(response)
                    
                }
                xhr.send(newFormData)

            }
        }
        // end of new blog

        blogForm.addEventListener("submit", eventHandler)


    </script>
{% endblock content %} 





